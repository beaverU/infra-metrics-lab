# infra-metrics-lab

Стенд для тестирования мониторинга: создание виртуальной машины через Vagrant, настройка с помощью Ansible и развёртывание стека мониторинга с помощью Docker Compose.

## Как запустить

### Требования

- **x86_64 PC**
- **Vagrant**
- **VirtualBox версии, совместимой с вашей версией Vagrant**
  - по [ссылке](https://developer.hashicorp.com/vagrant/docs/providers/virtualbox) можно проверить совместимость версий

### Запуск

``` bash
git clone <infra-metric-lab> && \
cd <infra-metric-lab> && \
vagrant up
```

## Этапы создания проекта

### Этап 1: Подготовка среды разработки

- Установка Vagrant и VirtualBox
- Создание Vagrantfile для развертывания Ubuntu VM
  - `vagrant init` для создания скелета файла
  - Читаем комментарии, конфигурируем необходимую для стенда ВМ. При необходимости смотрим документацию.
  - В конце файла запускаем провижинг с помощью Ansible, который будет выполняться внутри ВМ.

### Этап 2: Настройка VM с помощью Ansible

- Создание playbook.yml как основного сценария Ansible
- Добавляем задачи по:
  - Обновлению всех пакетов в системе
  - Синхронизации системного времени
  - Установке Docker и Docker Compose
  - Разворачиванию контейнеров Prometheus и Grafana через Docker Compose
- Применяем роль из Ansible Galaxy `ableton.prometheus_node_exporter` на VM для установки Node Exporter

### Этап 3: Развёртывание стека мониторинга

- Создаём docker-compose.yml файл, где будем описывать конфигурацию запускаемых контейнеров
- Запуск Prometheus и Grafana через Docker Compose
- Настройка Prometheus на сбор метрик с Node Exporter, работающего на той же ВМ.
- Пробрасываем в контейнер файлы для провиженинга и автоматической настройки Grafana. Также включаем анонимный доступ с административными правами (без пароля). Что не очень хорошо с точки зрения безопасности, но для демонстрационных целей подходит лучше.

### Этап 4: Доступ и мониторинг

- Открытие Grafana по адресу `http://localhost:3000`
- Просмотр метрик: CPU, память, диск и другие

---

## Схема стенда

![alt text](images/lab_scheme.png)

## С какими сложностями столкнулся

- После запуска `vagrant up` машина успешно создавалась, однако playbook не запускался с ошибкой:
 **'Specified hosts and/or --limit does not match any hosts'**
  - **Решение:** Не найдя нигде параметра *--limit*, который бы явно указывался, я решил запустить провижонинг с опцией
    `ansible.verbose = true`, которая выводит отладочные сообщения при работе скрипта. Так я понял, что по умолчанию
    playbook запускается c *--limit={vm.define.value}*, что в моём случае **metrics-lab**. Значит можно или переопределить
    опцию --limit при запуске, или изменить название хоста в playbook на необходимое. Я выбрал второй вариант.

- На этапе запуска docker compose появлялась ошибка о несовместимости версий файла конфигурации и исполняемого файла docker-compose
  - **Решение:** Зашёл на машину и выяснил, что почему-то установилась довольно старая версия docker-compose. Поискав в репозитории `apt search docker-compose` я обнаружил, что есть несколько вариаций этой программы. Для совместимости со старыми версиями (по аналогии с python & python3), начиная с версии 2, программа называется **docker-compose-v2** и запускается одна не как отдельная программа, а как часть docker: `docker compose up -d`

- Prometheus не мог достучаться до Node Exporter. Появлялась ошибка **"Connection refused"**
  - **Решение:** Можно или запускать контейнер с Prometheus в сети хоста или добавить в hosts файл контейнера запись, по которой можно обратиться к хосту

- Странное поведение: первый раз `vagrant up` отрабатывает без ошибок, но если удалить ВМ `vagrant destroy` и поднять заново, то
 запуск плейбука падает с ошибкой **/vagrant/ansible/roles/ableton.prometheus_node_exporter doesn't appear to contain a role**
  - **Решение:** Так как директория с файлами связана с директорией на физическом компьютере, то все файлы, которые туда
  сохраняет виртуальная машина в ходе работы сохраняются даже после перезагрузки. И если в первый запуск там ещё нет
  директории *roles/* то на второй запуск она уже есть. Почему то при запуске плейбука важно, чтобы там не было уже установленных ролей,
  поэтому решение которое я нашёл не самое элегантное, но работающее: просто удалять папку *roles/* после успешного прогона
  плейбука.
